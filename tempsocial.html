<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Social Wall</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      color: #fff;
    }
    #main-container {
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 8px #000;
      padding: 1.2em 1.2em 1em 1.2em;
      margin: 2em auto 0 auto;
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    h2 {
      margin-top: 2em;
      color: #fff;
      font-weight: 600;
      letter-spacing: 1px;
      text-align: center;
    }
    #my-id {
      font-weight: bold;
      color: #fff;
      background: #333;
      padding: 0.4em 0.7em;
      border-radius: 6px;
      margin-bottom: 0.2em;
      text-align: center;
      font-size: 1em;
      letter-spacing: 0.5px;
    }
    #room-section {
      display: flex;
      gap: 0.5em;
      margin-bottom: 0.5em;
      justify-content: center;
      align-items: center;
    }
    #room-select {
      flex: 1;
      padding: 0.5em 0.7em;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 1em;
      background: #181818;
      color: #fff;
    }
    #join-btn {
      background: #fff;
      color: #111;
      border: none;
      border-radius: 6px;
      padding: 0.5em 1em;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }
    #join-btn:hover {
      background: #bbb;
    }
    #current-room {
      color: #bbb;
      background: #181818;
      border-radius: 6px;
      padding: 0.2em 0.7em;
      text-align: center;
      font-size: 0.97em;
      margin-bottom: 0.5em;
      min-height: 1.5em;
    }
    #clear-btn {
      background: #fff;
      color: #111;
      border: none;
      border-radius: 6px;
      padding: 0.4em 1em;
      font-size: 0.98em;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 0.5em;
      margin-top: -0.3em;
      align-self: flex-end;
    }
    #clear-btn:hover {
      background: #bbb;
    }
    #wall {
      border: 1px solid #444;
      background: #181818;
      border-radius: 8px;
      height: 260px;
      overflow-y: auto;
      padding: 0.7em;
      margin-bottom: 0.5em;
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      font-size: 1em;
      color: #fff;
    }
    .post {
      background: #333;
      border-radius: 10px;
      padding: 0.7em 1em;
      margin-bottom: 0.1em;
      display: flex;
      flex-direction: column;
      gap: 0.2em;
      word-break: break-word;
    }
    .post .meta {
      font-size: 0.85em;
      color: #aaa;
      margin-top: 0.2em;
      text-align: right;
    }
    .post.me {
      background: #fff;
      color: #111;
    }
    .post.system {
      background: #222;
      color: #bbb;
      font-style: italic;
      text-align: center;
      font-size: 0.97em;
    }
    #post-form {
      display: flex;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    #post-input {
      flex: 1;
      padding: 0.5em 0.7em;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 1em;
      background: #181818;
      color: #fff;
    }
    #post-form button {
      background: #fff;
      color: #111;
      border: none;
      border-radius: 6px;
      padding: 0.5em 1em;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }
    #post-form button:hover {
      background: #bbb;
    }
    @media (max-width: 700px) {
      #main-container {
        margin: 0 auto;
        max-width: 98vw;
      }
    }
    @media (max-width: 500px) {
      #main-container {
        padding: 0.7em 0.2em 0.7em 0.2em;
        max-width: 98vw;
      }
      #wall {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <h2>P2P Social Wall</h2>
    <div id="my-id"></div>
    <div id="room-section">
      <select id="room-select">
        <option value="general">General Chat</option>
        <option value="school">School</option>
        <option value="videogames">Video Games</option>
      </select>
      <button id="join-btn">Join Room</button>
    </div>
    <div id="current-room"></div>
    <button id="clear-btn" type="button">Clear Wall</button>
    <div id="wall"></div>
    <form id="post-form" autocomplete="off">
      <input id="post-input" placeholder="Share something..." maxlength="200" required>
      <button type="submit">Post</button>
    </form>
  </div>
  <script>
    // --- Social wall with preset rooms ---
    let myShortId = localStorage.getItem('myShortId');
    if (!myShortId) {
      myShortId = Math.floor(100000 + Math.random() * 900000).toString();
      localStorage.setItem('myShortId', myShortId);
    }

    const roomNames = {
      general: "General Chat",
      school: "School",
      videogames: "Video Games"
    };

    let currentRoom = "general";
    let peer = null;
    let conn = null;
    let connectedPeerId = null;

    function updateRoomDisplay() {
      document.getElementById('current-room').textContent = "Room: " + roomNames[currentRoom];
    }

    function connectToRoom() {
      if (peer) {
        peer.destroy();
      }
      peer = new Peer(currentRoom + "-" + myShortId, { debug: 2 });
      peer.on('open', id => {
        document.getElementById('my-id').textContent = 'Your ID: ' + myShortId;
        updateRoomDisplay();
        appendPost({sender: 'System', text: 'Joined room ' + roomNames[currentRoom], type: 'system'});
        setTimeout(() => {
          if (peer) tryAutoConnect();
        }, 1000);
      });
      peer.on('connection', connection => {
        if (conn && conn.open) conn.close();
        conn = connection;
        connectedPeerId = connection.peer;
        updateRoomDisplay();
        setupConnection(conn);
      });
    }

    document.getElementById('join-btn').onclick = () => {
      let room = document.getElementById('room-select').value;
      currentRoom = room;
      document.getElementById('wall').innerHTML = '';
      connectToRoom();
    };

    // Connect to another peer in the same room
    function connectToPeer(peerId) {
      if (conn && conn.open) conn.close();
      conn = peer.connect(peerId, { reliable: true });
      connectedPeerId = peerId;
      updateRoomDisplay();
      setupConnection(conn);
    }

    function setupConnection(connection) {
      if (!connection) return;
      connection.on('open', () => {
        appendPost({sender: 'System', text: 'Connected to peer!', type: 'system'});
        updateRoomDisplay();
      });
      connection.on('data', data => {
        if (data && data.type === 'post') {
          appendPost(data, false);
        }
      });
      connection.on('close', () => {
        appendPost({sender: 'System', text: 'Connection closed.', type: 'system'});
        connectedPeerId = null;
        updateRoomDisplay();
      });
      connection.on('error', err => {
        appendPost({sender: 'System', text: 'Connection error: ' + err, type: 'system'});
        connectedPeerId = null;
        updateRoomDisplay();
      });
    }

    // Auto-connect to another peer in the room if possible
    function tryAutoConnect() {
      peer.listAllPeers(peers => {
        const roomPrefix = currentRoom + "-";
        const others = peers.filter(pid => pid.startsWith(roomPrefix) && !pid.endsWith(myShortId));
        if (others.length > 0) {
          connectToPeer(others[0]);
        }
      });
    }

    // Post to wall
    document.getElementById('post-form').onsubmit = e => {
      e.preventDefault();
      const input = document.getElementById('post-input');
      const text = input.value.trim();
      if (!text) return;
      const post = {
        sender: myShortId,
        text,
        type: 'me',
        timestamp: Date.now()
      };
      if (conn && conn.open) {
        conn.send({type: 'post', sender: myShortId, text, timestamp: post.timestamp});
      }
      appendPost(post, true);
      input.value = '';
    };

    // Append post to wall and auto-delete after 10 minutes
    function appendPost(post, isMine = false) {
      const wall = document.getElementById('wall');
      const div = document.createElement('div');
      div.className = 'post' + (post.type === 'system' ? ' system' : isMine ? ' me' : '');
      let meta = '';
      if (post.type !== 'system') {
        const date = post.timestamp ? new Date(post.timestamp) : new Date();
        meta = `<div class="meta">by ${post.sender}${isMine ? ' (You)' : ''} &middot; ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}</div>`;
      }
      div.innerHTML = `<div>${post.type === 'system' ? '<em>' + post.text + '</em>' : post.text}</div>${meta}`;
      wall.appendChild(div);
      wall.scrollTop = wall.scrollHeight;
      if (post.type !== 'system') {
        setTimeout(() => {
          div.remove();
        }, 10 * 60 * 1000); // 10 minutes
      }
    }

    // Clear wall functionality
    document.getElementById('clear-btn').onclick = () => {
      document.getElementById('wall').innerHTML = '';
    };

    // Initial join to default room
    connectToRoom();
  </script>
</body>
</html>